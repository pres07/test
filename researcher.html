<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Survey Embedder • Researcher Portal</title>
  <link rel="stylesheet" href="researcher.css" />
</head>
<body>
  <div class="wrap">
    <h1>Survey Embedder</h1>

    <div class="grid">
      <!-- Left: form & saved list -->
      <div class="card">
        <h2 style="margin:0 0 8px;font-size:16px;">Add / Edit Survey</h2>
        <form id="form">
          <label for="title">Survey Title</label>
          <input id="title" type="text" placeholder="e.g., Digital Habits – Week 3" required />

          <label for="url">Survey URL</label>
          <input id="url" type="url" inputmode="url" placeholder="https://…" required />
          <div class="hint">
            Supports Microsoft Forms, Google Forms, Qualtrics, SurveyMonkey, Typeform, etc.
          </div>

          <div class="row">
            <div>
              <label for="provider">Provider (optional)</label>
              <select id="provider">
                <option value="">Auto-detect</option>
                <option value="microsoftform">Microsoft Forms</option>
                <option value="googleforms">Google Forms</option>
                <option value="qualtrics">Qualtrics</option>
                <option value="surveymonkey">SurveyMonkey</option>
                <option value="typeform">Typeform</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div>
              <label for="Description">Description</label>
              <input id="Description" type="text" placeholder="Add Description" />
            </div>
          </div>

          <div class="row">
            <label style="display:flex;align-items:center;gap:8px;margin:10px 0;">
              <input id="appendParams" type="checkbox" checked />
              Append tracking params
            </label>
            <label style="display:flex;align-items:center;gap:8px;margin:10px 0;">
              <input id="tryEmbed" type="checkbox" checked />
              Try to embed in iframe
            </label>
          </div>

          <div class="row">
            <button type="submit" class="btn primary">Save Survey</button>
            <button type="button" id="resetBtn" class="btn ghost">Clear</button>
          </div>
          <div id="formMsg" class="status" aria-live="polite"></div>
          <input id="editIndex" type="hidden" />
        </form>

        <hr style="border:none;border-top:1px solid #e2e8f0;margin:16px 0" />

        <div class="flex" style="justify-content:space-between;">
          <h2 style="margin:0 0 8px;font-size:16px;">Saved Surveys</h2>
          <button id="exportBtn" class="btn ghost" title="Copy list as JSON">Copy JSON</button>
        </div>
        <table class="table" id="list">
          <thead>
            <tr>
              <th>Title</th>
              <th>Provider</th>
              <th>URL</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="5" style="color:#94a3b8;">No surveys yet.</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Right: preview -->
      <div class="card">
        <h2 style="margin:0 0 8px;font-size:16px;">Preview</h2>
        <div id="previewMeta" class="flex" style="justify-content:space-between;margin-bottom:8px;">
          <div id="currentTitle" class="pill">No selection</div>
          <div class="flex" id="currentTags"></div>
        </div>

        <iframe id="frame" title="Survey preview"></iframe>

        <div class="flex" style="margin-top:10px;justify-content:space-between;">
          <div id="embedStatus" class="status warn">Select a survey to preview.</div>
          <div class="actions">
            <button id="openBtn" class="btn">Open in new tab</button>
          </div>
        </div>
        <div class="hint" style="margin-top:8px;">
          Note: Some providers block embedding. If blank, use "Open in new tab".
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    
    // Use localStorage instead of API
    const STORAGE_KEY = 'surveys';
    
    const state = {
      surveys: [],
      selectedIndex: -1,
    };

    // ===== LOCALSTORAGE FUNCTIONS =====
    function loadSurveys() {
      try {
        state.surveys = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      } catch {
        state.surveys = [];
      }
      // Ensure all surveys have a status
      let changed = false;
      state.surveys.forEach(s => {
        if (!s.status) { s.status = 'pending'; changed = true; }
      });
      if (changed) saveSurveys();
      renderList();
    }

    function saveSurveys() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.surveys));
    }

    // ===== PROVIDER VALIDATION =====
    const providerPatterns = {
      microsoftform: { pattern: /forms\.office\.com|forms\.microsoft\.com/i, name: 'Microsoft Forms' },
      googleforms: { pattern: /docs\.google\.com\/forms/i, name: 'Google Forms' },
      qualtrics: { pattern: /qualtrics\.com/i, name: 'Qualtrics' },
      surveymonkey: { pattern: /surveymonkey\.com/i, name: 'SurveyMonkey' },
      typeform: { pattern: /typeform\.com/i, name: 'Typeform' }
    };

    function validateProviderUrl(url, provider) {
      if (!provider || provider === '' || provider === 'other') return { valid: true };
      const info = providerPatterns[provider];
      if (!info) return { valid: true };
      if (!info.pattern.test(url)) {
        return { valid: false, message: `URL does not match ${info.name}.` };
      }
      return { valid: true };
    }

    // ===== HELPERS =====
    function uid(len=8) { return Math.random().toString(36).slice(2, 2+len); }

    function detectProvider(u) {
      const h = u.toLowerCase();
      if (h.includes('forms.office.com')) return 'microsoftform';
      if (h.includes('docs.google.com/forms')) return 'googleforms';
      if (h.includes('qualtrics.com')) return 'qualtrics';
      if (h.includes('surveymonkey.com')) return 'surveymonkey';
      if (h.includes('typeform.com')) return 'typeform';
      return 'other';
    }

    function normalizeUrl(raw, provider, opts) {
      try {
        const url = new URL(raw);
        if (!provider || provider === 'other') provider = detectProvider(raw);
        if (provider === 'googleforms' && !url.searchParams.has('embedded')) {
          url.searchParams.set('embedded', 'true');
        }
        if (opts.appendParams) {
          if (opts.Description) url.searchParams.set('Description', opts.Description);
          if (opts.studyId) url.searchParams.set('studyId', opts.studyId);
        }
        return url.toString();
      } catch { return raw; }
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function renderList() {
      const tbody = $('tbody');
      tbody.innerHTML = '';
      if (state.surveys.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="color:#94a3b8;">No surveys yet.</td></tr>';
        return;
      }
      state.surveys.forEach((s, i) => {
        const provider = s.provider || detectProvider(s.url);
        const status = s.status || 'pending';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(s.title || '(untitled)')}</td>
          <td><span class="tag">${provider}</span></td>
          <td style="max-width:300px;word-break:break-all;color:#93c5fd;">${escapeHtml(s.url)}</td>
          <td><span class="tag status-pill status-${status}">${status}</span></td>
          <td class="actions">
            <button class="btn" data-act="preview" data-i="${i}">Preview</button>
            <button class="btn" data-act="publish" data-i="${i}" ${status !== 'approved' ? 'disabled title="Awaiting approval"' : ''}>Publish</button>
            <button class="btn" data-act="edit" data-i="${i}">Edit</button>
            <button class="btn ghost" data-act="del" data-i="${i}">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    function clearForm() {
      $('title').value = '';
      $('url').value = '';
      $('provider').value = '';
      $('Description').value = '';
      $('appendParams').checked = true;
      $('tryEmbed').checked = true;
      $('editIndex').value = '';
      $('formMsg').textContent = '';
    }

    function setPreview(index) {
      state.selectedIndex = index;
      const s = state.surveys[index];
      $('currentTitle').textContent = s.title || '(untitled)';
      
      const tags = $('currentTags');
      tags.innerHTML = '';
      [s.provider || detectProvider(s.url), s.studyId ? `study:${s.studyId}` : '']
        .filter(Boolean).forEach(t => {
          const span = document.createElement('span');
          span.className = 'tag';
          span.textContent = t;
          tags.appendChild(span);
        });

      const frame = $('frame');
      frame.removeAttribute('src');
      
      if ($('tryEmbed').checked) {
        $('embedStatus').className = 'status warn';
        $('embedStatus').textContent = 'Loading…';
        frame.onload = () => {
          $('embedStatus').className = 'status ok';
          $('embedStatus').textContent = 'Loaded. If blank, provider blocks framing.';
        };
        frame.src = s.url;
      } else {
        $('embedStatus').className = 'status warn';
        $('embedStatus').textContent = 'Embedding disabled.';
      }
      
      $('openBtn').onclick = () => window.open(s.url, '_blank', 'noopener');
    }

    // ===== EVENT HANDLERS =====
    $('tbody').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const i = +btn.dataset.i;
      const act = btn.dataset.act;

      if (act === 'preview') setPreview(i);
      
      if (act === 'publish') {
        const s = state.surveys[i];
        if (s.status !== 'approved') {
          alert('Survey must be approved by admin first.');
          return;
        }
        alert('Survey published! (demo)');
      }
      
      if (act === 'edit') {
        const s = state.surveys[i];
        $('title').value = s.title || '';
        $('url').value = s.rawUrl || s.url || '';
        $('provider').value = s.provider || '';
        $('Description').value = s.Description || '';
        $('appendParams').checked = s.appendParams !== false;
        $('editIndex').value = s.studyId;
        $('formMsg').className = 'status';
        $('formMsg').textContent = 'Editing…';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      
      if (act === 'del') {
        if (confirm('Delete this survey?')) {
          state.surveys.splice(i, 1);
          saveSurveys();
          renderList();
          if (state.selectedIndex === i) {
            $('frame').removeAttribute('src');
            $('embedStatus').textContent = 'Select a survey to preview.';
            $('currentTitle').textContent = 'No selection';
            $('currentTags').innerHTML = '';
          }
        }
      }
    });

    $('form').addEventListener('submit', (e) => {
      e.preventDefault();
      const title = $('title').value.trim();
      const rawUrl = $('url').value.trim();
      const provider = $('provider').value.trim();
      const Description = $('Description').value.trim();
      const appendParams = $('appendParams').checked;

      try { new URL(rawUrl); } catch {
        $('formMsg').className = 'status err';
        $('formMsg').textContent = 'Invalid URL.';
        return;
      }

      const validation = validateProviderUrl(rawUrl, provider);
      if (!validation.valid) {
        $('formMsg').className = 'status err';
        $('formMsg').textContent = validation.message;
        return;
      }

      const editId = $('editIndex').value || null;
      let studyId, createdAt, status;

      if (editId) {
        const existing = state.surveys.find(s => s.studyId === editId);
        studyId = editId;
        createdAt = existing?.createdAt || Date.now();
        status = existing?.status || 'pending';
        const idx = state.surveys.findIndex(s => s.studyId === editId);
        if (idx > -1) state.surveys.splice(idx, 1);
      } else {
        studyId = 'study_' + uid(6);
        createdAt = Date.now();
        status = 'pending';
      }

      const finalUrl = normalizeUrl(rawUrl, provider, { appendParams, Description, studyId });

      state.surveys.push({
        title, url: finalUrl, rawUrl, provider, Description,
        appendParams, studyId, createdAt, status
      });

      saveSurveys();
      renderList();
      clearForm();
      $('formMsg').className = 'status ok';
      $('formMsg').textContent = 'Saved!';
      setTimeout(() => $('formMsg').textContent = '', 2000);
    });

    $('resetBtn').onclick = clearForm;
    $('exportBtn').onclick = () => {
      navigator.clipboard.writeText(JSON.stringify(state.surveys, null, 2))
        .then(() => alert('Copied to clipboard.'));
    };

    // Initialize
    loadSurveys();
  </script>
</body>
</html>
